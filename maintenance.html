<html lang="en" ng-app="myApp">
  <head>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.9.4/angular-material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=RobotoDraft:300,400,500,700,400italic">
    <meta name="viewport" content="initial-scale=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Detail Page</title>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" />
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
      <style>
      .inputdemoBasicUsage .md-datepicker-button {
  width: 36px; }
    .gridListdemoDynamicTiles md-icon {
  width: 50%;
  height: 30%; }
.gridListdemoBasicUsage md-grid-list {
  margin: 8px; }
.gridListdemoBasicUsage .gray {
  background: #f5f5f5; }
.gridListdemoBasicUsage .green {
  background: #b9f6ca; }
.gridListdemoBasicUsage .yellow {
  background: #ffff8d; }
.gridListdemoBasicUsage .blue {
  background: #84ffff; }
.gridListdemoBasicUsage .purple {
  background: #b388ff; }
.gridListdemoBasicUsage .red {
  background: #ff8a80; }
.gridListdemoBasicUsage md-grid-tile {
  transition: all 400ms ease-out 50ms; 
} 
      </style>
  </head>
  <body  >
      <div ng-app="myApp" ng-controller="customersCtrl">
              <nav class="navbar navbar-inverse">
            <div class="container-fluid" >
                <div class="navbar-header ">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                    <a class="navbar-brand" href="/dashboard">K.V.Phase-II</a>
                </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav navbar-left">
                        <li class="inactive"><a href="">Home</a></li>
                        <li class="inactive" ng-click="searched = false;flatNumberEntered='' "><a href="/dashboard">Dashboard</a></li>
                        <li class="inactive"><a href="/receipts">Receipts</a></li>
                        <!--<li class="inactive"><a href="/email">Emails</a></li> -->
                        <li class="active"><a href="">Maintenance</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
                        <li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    <!-- Angular Material Dependencies -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-animate.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-aria.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.9.4/angular-material.min.js"></script>

                              <div class="form-group">
              
                              <div class="row">
<div class="col-sm-11 col-md-11">                  
<div ng-init="selectedyear=end;month.name=years[m-1];month.id=m;sendDate(m,selectedyear)">
                    <label>Year</label>
        <select  ng-model="selectedyear"  id="year" ></select>
    
                <label>Month</label>
        <select  ng-model="selectedmonth"  ng-click="selectedmonth!=NULL && sendDate(selectedmonth,selectedyear)">
    <option ng-repeat="option in months"  value="{{option.id}}">{{option.name}}</option>
            
    </select>    
    
</div>
                              </div>
                              <div class="col-sm-1 col-md-1"> 
                                            <md-button class="md-warn md-raised md-fab md-mini" aria-label="Eat cake" data-toggle="modal" data-target="#mailModal" data-whatever="@mdo">
                                  <span class="glyphicon glyphicon-send"></span>
                    <md-tooltip> Send Remainder Mails</md-tooltip>

                                  </md-button>
                                       </div>
                        </div>
          </div>
    
     <div style="margin:50px">
           <md-grid-list
        md-cols-sm="1" md-cols-md="1" md-cols-gt-md="30"
        md-row-height-gt-md="1:1" md-row-height="4:3"
        md-gutter="4px" md-gutter-gt-sm="2px" >
    <md-grid-tile ng-repeat="x in flatnos" 
                  md-colspan-sm="1" style="background-color:{{getcolor(x)}}">
        {{x.FLAT_NO}}
    </md-grid-tile>
  </md-grid-list>
          </div>
          
          <div class="modal fade" id="mailModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="exampleModalLabel">EMAIL TEMPLATE</h4>
      </div>
      <div class="modal-body">
        <form>
                 <h3>Hello,<br>

This is a gentle reminder that you have not yet paid the maintenance <br>

Please pay it as soon as possible <br>

Regards <br>
Heads <br>                       
            </h3>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal" ng-click="sendmails()">Send Mails</button>
      </div>
    </div>
  </div>
</div>

      </div>
      <script>
      var app = angular.module('myApp', ['ngMaterial']);
    app.controller('customersCtrl', function ($scope, $http, DataService) 
    {
            $scope.searched = false;
            $scope.ownerdbid="";
            $scope.flatdbid="";
            $scope.tenantdbid="";
            $scope.ownerid = "";
            $scope.flatNumberEntered;
            $scope.flatno="";            
            $scope.color =[ 'red' , 'green' ];
            $scope.years =[ 'JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC' ];
            $scope.showsidenav=true;
            $scope.t="";
            $scope.o="";
            $scope.f="";
            $scope.date = new Date();
            var previousMonth = new Date($scope.date);
            var previousYear = new Date($scope.date);
            $scope.dateEditorEnabled = false;
            
            $scope.emailcontent="";
    
            var start = 2010;
            $scope.end = new Date().getFullYear();
            var e=$scope.end;
            var options = "";
            for(var year = $scope.end ; year >=start; year--)
            {
                options += "<option>"+ year +"</option>";
            }
            $scope.m=new Date().getMonth()+1;
            document.getElementById("year").innerHTML = options;            
            $scope.months=[
                    {id: '1', name: 'JAN'},
                    {id: '2', name: 'FEB'},
                    {id: '3', name: 'MAR'},
                    {id: '4', name: 'APR'},
                    {id: '5', name: 'MAY'},
                    {id: '6', name: 'JUN'},
                    {id: '7', name: 'JUL'},
                    {id: '8', name: 'AUG'},
                    {id: '9', name: 'SEP'},
                    {id: '10', name: 'OCT'},                    
                    {id: '11', name: 'NOV'},
                    {id: '12', name: 'DEC'}
            ];        

            $scope.getcolor = function(x)
            {
                if(x.status == 1)
                    return 'green';
                else 
                    return 'red';
            }

            $scope.duestatus = function(month,selectedyear)
            {
/*                var params = {
                        month:month,
                        year:selectedyear
                    }

                    $http({
                        url: '/sendstatus/',
                        method: 'GET',
                        params: params
                    }).success(function (response) { $scope.grid=response.flats; });
*/
                console.log("HIE");
                    return $http.get("/sendstatus/"+month+"/:"+selectedyear, {
                    
                }).success(function (response) { $scope.grid=response.flats; });

            }            
            $scope.formarray = function(month,selectedyear)
            {
                $scope.duestatus(month,selectedyear);
                console.log("HELO");
                for(var i=0; $scope.flatnos && i< $scope.flatnos.length ; i++)
                {
                    $scope.flatnos[i].status=0;
                    
                    for(j=0;$scope.grid && j<$scope.grid.length;j++)
                    {
                        
                        if($scope.flatnos[i].FLAT_NO === $scope.grid[j].FLAT_NO)
                        {
                            console.log("haha");
                            console.log($scope.flatnos[i].FLAT_NO);
                            $scope.flatnos[i].status=1;
                            break;
                        }
                    }
                }
            }

            $scope.sendDate = function(month,selectedyear)
            {
                console.log(month);
                console.log(selectedyear);
                $http.get("/getFlats").success(function (response) { $scope.flatnos=response.flats; });
                $scope.formarray(month,selectedyear);
            }
            $scope.mails = function(flatno)
            {
                return $http.get("/sendMail/", {
                        params: { FLAT_NO:flatno }    
                            }).success(function (response) { $scope.j=$scope.docs;});
            }            
            $scope.sendmails = function()
            {
                console.log("Succes");
                for(var i=0; i<$scope.flatnos.length ; i++)
                {
                    if($scope.flatnos[i].status === 0)
                    {
                            $scope.mails(flatnos[i].FLAT_NO);
                    }
                }
            }

            $scope.getFlatDetails = function (inputsearch) 
            {
                inputsearch = angular.uppercase(inputsearch);
        
                $scope.resetLabels();
                if(inputsearch == "")
                {
                }
                else
                {
                    $scope.searched = true;
                    console.log(inputsearch);
                    for (var i = 0; i < $scope.flat.length; i++) 
                    {
                        if ($scope.flat[i].FLAT_NO === inputsearch) 
                        {
                            $scope.f = $scope.flat[i];
                            $scope.ownerid = $scope.flat[i].OWNERS;
                            $scope.flatdbid =$scope.flat[i]._id;
                            $scope.flatno = $scope.flat[i].FLAT_NO;
                            for (var j = 0; j < $scope.owners.length; j++) 
                            {
                                if($scope.ownerid === $scope.owners[j].OWNER_ID)
                                {
                                    $scope.o=$scope.owners[j];
                                    $scope.ownerdbid = $scope.owners[j]._id;
                                }
                            }
                        }
                    }
                    for(var k=0;k < $scope.tenants.length;k++)
                    {
                        if($scope.tenants[k].FLAT_NO === inputsearch)
                        {
                            $scope.t=$scope.tenants[k];
                            $scope.tenantdbid = $scope.tenants[k]._id;
                        }
                    }
                }
            }
                     
            $scope.getDetails = function() {
                DataService.getOwnersData().then(
                    $scope.getOwnersDataSuccessHandler
                );
            }
            
            $scope.getOwnersDataSuccessHandler = function(response)
            {
                console.log(response);
                $scope.owners = response.data.docs;
                console.log($scope.owners);
                $scope.getOwnerDetails();
                $scope.firstFunction();
                $scope.getRandomSpan();

            }
            
            $scope.getOwnerDetails = function()
            {
                for(var i=0;i< $scope.owners.length; i++)
                {
                    $scope.getOwnedFlats(i); 
                }    
            }
            
            $scope.getOwnedFlats = function(particularOwner)
            {
                i = particularOwner;
                $scope.ownerId = $scope.owners[particularOwner].OWNER_ID; 
                for(var i =0; i< $scope.flat.length; i++)
                {
                    if($scope.flat[i].OWNERS == $scope.ownerId)
                    {
                        $scope.owners[particularOwner].ownedFlats=$scope.flat[i].FLAT_NO;
                    }
                }
            }
                        
            $scope.sendEmailTemplate = function()
            {
                $http.get("/email")
                    .success(function (response) { $scope.emailcontent=response.docs; });
            }
                    

            $scope.getRandomSpan =function()
            {
                for(var i=0;i<$scope.owners.length;i++)
                {
                    $scope.owners[i].dues=Math.floor(Math.random()*2);
                    $scope.duestatusfn($scope.tenants[i].FLAT_NO,$scope.end);
                    if($scope.duesoftheyear[i]=== 0)
                    {
                        $scope.tenants[i].dues=1;
                        break;
                    }
                    else if($scope.duesoftheyear[i] ===1 || $scope.duesoftheyear[i] ===2)
                    {
                        $scope.tenants[i].dues= 0;
                    }
                    
                }
            }

            $scope.firstFunction = function()
            {
                for(var i=0; i<$scope.tenants.length ;i++)
                {
                    if($scope.tenants[i].FIRST_NAME === "" && $scope.tenants[i].MIDDLE_NAME === "" && $scope.tenants[i].LAST_NAME === "" )
                    {
                        for(var j=0; j<$scope.owners.length ; j++)
                        {
                            if($scope.owners[j].ownedFlats === $scope.tenants[i].FLAT_NO)
                            {
                                $scope.myjson[i].FIRST_NAME = $scope.owners[j].FIRST_NAME;
                                $scope.myjson[i].LAST_NAME = $scope.owners[j].LAST_NAME;
                                $scope.myjson[i].MIDDLE_NAME = $scope.owners[j].MIDDLE_NAME;
                                $scope.myjson[i].EMAIL_IDS = $scope.owners[j].EMAIL_IDS;
                                $scope.myjson[i].PHONE_NUMBERS = $scope.owners[j].PHONE_NUMBERS;                                
                            }
                        }
                        
                    }
                    
                }
            }
                                        
            $http.get("/flatDetails")
            .success(function (response) { $scope.flat = response.docs; });

            $http.get("/tenantDetails")
            .success(function (response) { $scope.tenants = response.docs;  $scope.myjson = response.docs;});
        
            $http.get("http://www.w3schools.com/angular/customers.php")
            .success(function(response) {$scope.w3 = response.records;});

        });

        app.factory("DataService",function($http,$location){
    
            var _getDataService = 
            {
                
                getOwnersData : function()
                {
            	   return $http.get('/ownerDetails');
                },
                getFlatsData : function()
                {
                    return $http.get('/flatDetails');
                },
                getTenantsData : function()
                {
                    return $http.get('/tenantDetails');
                },
            
            }
            
            return _getDataService;
        });
    </script>
    </body>
</html>
    